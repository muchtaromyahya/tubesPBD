ALTER SESSION SET nls_date_format = 'DD-MM-YYYY';

CREATE TABLE DEVELOPER(
    ID_DEVELOPER CHAR(10),
    NAMA_DEVELOPER VARCHAR2(50),
    ALAMAT_DEVELOPER VARCHAR2(255),
    EMAIL_DEVELOPER VARCHAR2(50),
    NO_TELEPON_DEVELOPER CHAR(12),
    CONSTRAINT DEVELOPER_PK PRIMARY KEY(ID_DEVELOPER)
);

CREATE TABLE RUMAH(
    ID_RUMAH CHAR(10),
    LUAS_RUMAH NUMBER,
    LUAS_TANAH_RUMAH NUMBER,
    HARGA_RUMAH NUMBER,
    ALAMAT_RUMAH VARCHAR2(255),
    ID_DEVELOPER CHAR(10),
    CONSTRAINT RUMAH_PK PRIMARY KEY(ID_RUMAH),
    CONSTRAINT RUMAH_FK FOREIGN KEY(ID_DEVELOPER) REFERENCES DEVELOPER (ID_DEVELOPER) ON DELETE CASCADE ENABLE
);

CREATE TABLE PEGAWAI_BANK(
    ID_PEGAWAI CHAR(10),
    NAMA_PEGAWAI VARCHAR2(50),
    TANGGAL_LAHIR_PEGAWAI DATE,
    ALAMAT_PEGAWAI VARCHAR2(255),
    EMAIL_PEGAWAI VARCHAR2(50),
    NO_TELEPON_PEGAWAI CHAR(12),
    CONSTRAINT PEGAWAI_BANK_PK PRIMARY KEY(ID_PEGAWAI)
);

CREATE TABLE NASABAH(
    NO_KTP_NASABAH CHAR(16),
    NAMA_NASABAH VARCHAR2(50),
    NO_REKENING_NASABAH CHAR(15),
    NO_TELP_NASABAH CHAR(12),
    PENGHASILAN_BERSIH_PERBULAN NUMBER,
    NPWP_NASABAH CHAR(15),
    ALAMAT_NASABAH VARCHAR2(255),
    JENIS_KELAMIN_NASABAH CHAR(1),
    TANGGAL_LAHIR_NASABAH DATE,
    CONSTRAINT NASABAH_PK PRIMARY KEY(NO_KTP_NASABAH)
);

CREATE TABLE KREDIT(
    KODE_KREDIT CHAR(10),
    LAMA_KREDIT INTEGER,
    SUKU_BUNGA_KREDIT NUMBER,
    TANGGAL_JATUH_TEMPO DATE,
    DP_KREDIT NUMBER,
    JUMLAH_PINJAMAN NUMBER,
    ANGSURAN_KREDIT NUMBER,
    ID_RUMAH CHAR(10),
    CONSTRAINT KREDIT_PK PRIMARY KEY(KODE_KREDIT),
    CONSTRAINT KREDIT_FK FOREIGN KEY(ID_RUMAH) REFERENCES RUMAH (ID_RUMAH) ON DELETE CASCADE ENABLE
);

CREATE TABLE TRANSAKSI(
    KODE_TRANSAKSI CHAR(10),
    TANGGAL_TRANSAKSI DATE,
    PEMBAYARAN_KE CHAR(6),
    KODE_KREDIT CHAR(10),
    NO_KTP_NASABAH CHAR(16),
    ID_PEGAWAI CHAR(10),
    CONSTRAINT TRANSAKSI_PK PRIMARY KEY (KODE_TRANSAKSI),
    CONSTRAINT TRANSAKSI_FK1 FOREIGN KEY (ID_PEGAWAI) REFERENCES PEGAWAI_BANK (ID_PEGAWAI),
    CONSTRAINT TRANSAKSI_FK2 FOREIGN KEY (NO_KTP_NASABAH) REFERENCES NASABAH (NO_KTP_NASABAH) ON DELETE CASCADE ENABLE,
    CONSTRAINT TRANSAKSI_FK3 FOREIGN KEY (KODE_KREDIT) REFERENCES KREDIT (KODE_KREDIT) ON DELETE CASCADE ENABLE
);


CREATE VIEW KREDIT_DETAIL AS
SELECT kode_kredit,lama_kredit,suku_bunga_kredit,tanggal_jatuh_tempo,
(harga_rumah*0.2) AS DP_KREDIT, 
(harga_rumah*0.8) AS JUMLAH_PINJAMAN, 
(FLOOR(((harga_rumah*0.8)/(LAMA_KREDIT*12))+((harga_rumah*0.8)*SUKU_BUNGA_KREDIT/12/100))) AS ANGSURAN_KREDIT,
id_rumah
FROM kredit
JOIN rumah USING(ID_RUMAH);


CREATE VIEW TRANSAKSI_DETAIL AS
SELECT kode_transaksi, tanggal_transaksi, pembayaran_ke, 
(FLOOR((angsuran_kredit) + ((floor(to_date(tanggal_transaksi)-to_date(tanggal_jatuh_tempo))*(-1))-(floor(to_date(tanggal_transaksi)-to_date(tanggal_jatuh_tempo))*(-1))))) AS JUMLAH_BAYAR,
((floor(to_date(tanggal_transaksi)-to_date(tanggal_jatuh_tempo))*(-1))-(floor(to_date(tanggal_transaksi)-to_date(tanggal_jatuh_tempo))*(-1))) AS DENDA,
kode_kredit, no_ktp_nasabah, id_pegawai
FROM transaksi
JOIN kredit_detail USING(kode_kredit);
